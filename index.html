<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Star Monsters Improved</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <style>
    body { margin: 0; overflow: hidden; font-family: 'Audiowide', sans-serif; color: white; }
    canvas { display: block; }
    @import url('https://fonts.googleapis.com/css2?family=Audiowide&display=swap');
  </style>
</head>
<body>
<script>
let player, enemies, bullets, enemyBullets, powerUps;
let score = 0, lives = 3, firepower = 1, level = 1;
let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function setup() {
  createCanvas(500, 500);
  resetGame();
}

function resetGame() {
  player = { x: width/2, y: height-60, size: 40, lives: 3, firepower: 1 };
  bullets = [];
  enemyBullets = [];
  powerUps = [];
  game.score = 0; // Reset Score here
  initEnemies();
}

function initEnemies() {
  enemies = [];
  for(let row=0; row<4; row++){
    for(let col=0; col<8; col++){
      enemies.push({x:50+col*50, y:50+row*40, alive:true});
    }
  }
}

function setup(){
  createCanvas(500,500);
  resetGame();
}

function draw(){
  background(0);
  drawPlayer();
  drawEnemies();
  drawBullets();
  updateBullets();
  drawEnemyBullets();
  updateEnemyBullets();
  drawPowerUps();
  updatePowerUps();
  checkCollisions();
  drawHUD();
}

function drawPlayer(){
  fill(0,255,0);
  rect(player.x, player.y, player.size, player.size/2);
}

function keyPressed(){
  if(keyCode === LEFT_ARROW) player.x -= 10;
  if(key === ' ') fireBullet();
  if(key === 'ArrowRight') player.x += 10;
  if(key === 'ArrowLeft') player.x -= 10;
}

function drawPlayer(){
  fill(0,255,0);
  rectMode(CENTER);
  rect(player.x, player.y, player.size, player.size);
}

function initEnemies(){
  enemies = [];
  for(let r=0; r<4; r++){
    for(let c=0; c<8; c++){
      enemies.push({x:50+cWidth()*c, y:50 + r*40, size:30, alive:true, row:r});
    }
  }
}

function drawEnemies(){
  fill(255,0,0);
  enemies.forEach(e=>{ if(e.alive) ellipse(e.x,e.y,e.size); });
}

function drawBullets(){
  fill(firepower>1?'orange':'cyan');
  bullets.forEach(b=>rect(b.x,b.y,5,15));
}

function updateBullets(){
  bullets.forEach(b=>b.y-=5);
  bullets=bullets.filter(b=>b.y>0);
}

function updateBullets(){
  bullets.forEach((b,i)=>{
    enemies.forEach(e=>{
      if(e.alive && dist(b.x,b.y,e.x,e.y)<15){
        e.alive=false;
        bullets.splice(i,1);
        game.score += 10;
        if(random()<0.05 && powerUps.length<1 && e.y<100){ // One random powerup
          powerUps.push({x:e.x,y:e.y,type:random()<0.5?'life':'fire'});
        }
      }
    });
  });
}

function drawEnemyBullets(){
  fill(255,50,50);
  enemyBullets.forEach(b=>rect(b.x,b.y,5,10));
}

function updateBullets(){
  bullets=bullets.filter(b=>b.y>0);
  bullets.forEach(b=>b.y-=5);
}

function updateEnemyBullets(){
  enemyBullets.forEach((b,i)=>{
    b.y+=3;
    if(dist(b.x,b.y,player.x,player.y)<20){
      player.lives--;
      enemyBullets.splice(i,1);
      player.firepower=1;
    }
  });
}

function drawPowerUps(){
  powerUps.forEach(p=>{
    fill(p.type==='life'?'lime':'yellow');
    ellipse(p.x,p.y,10);
  });
}

function updatePowerUps(){
  powerUps.forEach((p,i)=>{
    p.y+=2;
    if(dist(p.x,p.y,player.x,player.y)<20){
      if(p.type==='life'){
        if(player.lives<3){player.lives++; playSound(600);} else {game.score+=500; playSound(700);}
      }else{
        if(player.firepower<4){player.firepower=4; playSound(900);} else{game.score+=100;}
      }
      powerUps.splice(i,1);
    }
  });
}

function drawPowerUps(){
  powerUps.forEach(p=>{
    fill(p.type==='life'?'blue':'gold');
    ellipse(p.x,p.y,20);
  });
}

function fireBullet(){
  if(millis()-game.lastShot>game.shootDelay){
    for(let i=0;i<player.firepower;i++){
      bullets.push({x:player.x-15+(i*10), y:player.y-20});
    }
    game.lastShot=millis();
    playSound(800);
  }
}

function playSound(freq){
  let osc=game.audioCtx.createOscillator();
  let gain=game.audioCtx.createGain();
  osc.connect(gain); gain.connect(game.audioCtx.destination);
  osc.frequency.value=freq;
  osc.start();osc.stop(game.audioCtx.currentTime+0.1);
}

</script>
</body>
</html>
